<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrop | Request Tracking</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <script src="assets/js/api-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <style>
        .table-container {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #dc2626;
            color: white;
        }
        tr:hover { background-color: #f1f1f1; }
        .empty-message {
            text-align: center;
            padding: 20px;
            color: #555;
        }
        .status-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: default;
            color: white;
            font-weight: bold;
        }
        .status-pending { background: #f59e0b; }
        .status-approved { background: #16a34a; }
        .status-rejected { background: #dc2626; }
        .status-completed { background: #16a34a; }
        .status-cancelled { background: #dc2626; }
        .status-matched { background: #3b82f6; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="recipient_dash.html">Dashboard</a>
            <a href="requests.html">Create Request</a>
            <a href="request_track.html" class="active">Request Update</a>
            <a href="request_hist.html">Request History</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1>Track Your Requests</h1>
        </header>

        <div class="table-container">
            <h2>Your Requests Status</h2>
            <table id="trackTable">
                <thead>
                <tr>
                    <th>Request Date</th>
                    <th>Blood Type</th>
                    <th>Status</th>
                    <th>Hospital</th>
                    <th>Last Updated</th>
                </tr>
                </thead>
                <tbody id="trackBody">
                <!-- Rows will be dynamically added -->
                </tbody>
            </table>
            <div id="emptyMessage" class="empty-message hidden">No requests found.</div>
        </div>
    </main>
</div>

<script>
    // Check authentication and initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is authenticated and is a recipient
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'login.html';
            return;
        }

        const userInfo = AuthService.getUserInfo();
        if (!userInfo || userInfo.role !== 'RECIPIENT') {
            alert('Only recipients can view request tracking.');
            window.location.href = 'login.html';
            return;
        }

        fetchRequestTrack();
    });

    const trackBody = document.getElementById("trackBody");
    const emptyMessage = document.getElementById("emptyMessage");

    function getStatusClass(status) {
        switch(status?.toUpperCase()) {
            case 'PENDING': return 'status-pending';
            case 'APPROVED': return 'status-approved';
            case 'REJECTED': return 'status-rejected';
            case 'COMPLETED': return 'status-completed';
            case 'CANCELLED': return 'status-cancelled';
            case 'MATCHED': return 'status-matched';
            default: return '';
        }
    }

    async function fetchRequestTrack() {
        try {
            // Show loading state
            trackBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>';
            emptyMessage.classList.add("hidden");

            // Fetch requests for the current recipient
            const requests = await ApiService.get(`${API_CONFIG.endpoints.requests}/pending`);

            if (requests.length === 0) {
                trackBody.innerHTML = '';
                emptyMessage.textContent = "No pending requests found.";
                emptyMessage.classList.remove("hidden");
                return;
            }

            // Clear loading state
            trackBody.innerHTML = '';

            requests.forEach(req => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${Utils.formatDate(req.requiredDate)}</td>
                    <td>${req.bloodGroup || '-'}</td>
                    <td><span class="status-btn ${getStatusClass(req.status)}">${Utils.formatStatus(req.status)}</span></td>
                    <td>${req.hospital || '-'}</td>
                    <td>${Utils.formatDate(req.requiredDate)}</td>
                `;
                trackBody.appendChild(tr);
            });

        } catch (error) {
            console.error('Error fetching request tracking:', error);
            trackBody.innerHTML = '';
            emptyMessage.textContent = "Failed to fetch request data. Please try again.";
            emptyMessage.classList.remove("hidden");
        }
    }
</script>
</body>
</html>
