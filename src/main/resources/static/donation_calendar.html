<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrop | Donation Calendar</title>
    <link rel="stylesheet" href="assets/css/global.css">
    <script src="assets/js/api-config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9fafb;
            color: #222;
            margin: 0;
        }
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 230px; background: #dc2626; color: #fff; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-bottom: 20px; }
        .sidebar nav a { color: white; padding: 10px 0; display: block; border-radius: 6px; }
        .sidebar nav a.active, .sidebar nav a:hover { background: rgba(255,255,255,0.2); }
        .main-content { flex: 1; padding: 20px; }
        .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .topbar a { font-weight: bold; color: #000; text-decoration: none; }

        .calendar-container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 800px; margin-bottom: 30px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar div { padding: 10px; border-radius: 6px; }
        .calendar .header { font-weight: bold; background: #f3f4f6; }
        .calendar .donation { background: #16a34a; color: #fff; font-weight: bold; }
        .next-eligibility { background: #fef3c7; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="donor_dash.html" class="active">Dashboard</a>
            <a href="request_page.html">Find requests</a>
            <a href="track_donations.html">Track Donations</a>
            <a href="donation_calendar.html">Donation Calendar</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1>Donation Calendar</h1>
            <a href="profile_page.html">Profile</a>
        </header>

        <div class="next-eligibility" id="eligibility">
            Next Donation Eligibility: <span id="nextDate"></span> (<span id="eligibilityStatus"></span>)
        </div>

        <div class="calendar-container">
            <h2>Donation History</h2>
            <div class="calendar" id="calendar">
                <!-- Calendar populated by JS -->
            </div>
        </div>
    </main>
</div>

<script>
    const donorId = 1; // TODO: Replace with logged-in donor ID
    let donationDates = [];

    // Load donation calendar when page loads
    document.addEventListener('DOMContentLoaded', async function() {
        await loadDonationCalendar();
    });

    async function loadDonationCalendar() {
        try {
            // Fetch donation history from API
            const donations = await ApiService.get(`${API_CONFIG.endpoints.requests}/donor/${donorId}/history`);
            
            // Extract completed donation dates
            donationDates = donations
                .filter(donation => donation.status === 'COMPLETED')
                .map(donation => {
                    const date = new Date(donation.requiredDate);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                });

            updateEligibilityStatus();
            generateCalendar();
        } catch (error) {
            console.error('Error loading donation calendar:', error);
            // Show default calendar with no donations
            updateEligibilityStatus();
            generateCalendar();
        }
    }

    function updateEligibilityStatus() {
        const today = new Date();
        let nextEligible;
        let eligibleStatus;

        if (donationDates.length > 0) {
            // Calculate next eligibility (assuming 90 days between donations)
            const lastDonation = new Date(donationDates[donationDates.length - 1]);
            nextEligible = new Date(lastDonation);
            nextEligible.setDate(nextEligible.getDate() + 90);
            eligibleStatus = today >= nextEligible ? "Eligible" : "Not Eligible";
        } else {
            // No previous donations, eligible immediately
            nextEligible = today;
            eligibleStatus = "Eligible";
        }

        document.getElementById("nextDate").textContent = nextEligible.toDateString();
        document.getElementById("eligibilityStatus").textContent = eligibleStatus;
    }

    function generateCalendar() {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = ''; // Clear existing calendar

        const monthNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        monthNames.forEach(day => {
            const div = document.createElement("div");
            div.textContent = day;
            div.classList.add("header");
            calendar.appendChild(div);
        });

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Add blank divs for first day offset
        for(let i = 0; i < firstDay; i++){
            const div = document.createElement("div");
            calendar.appendChild(div);
        }

        // Add days
        for(let day = 1; day <= daysInMonth; day++){
            const div = document.createElement("div");
            const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            div.textContent = day;
            if(donationDates.includes(dayStr)){
                div.classList.add("donation");
            }
            calendar.appendChild(div);
        }
    }
</script>
</body>
</html>
