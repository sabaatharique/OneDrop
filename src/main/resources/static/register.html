<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | Register</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/auth.css" />
    <script src="assets/js/auth.js"></script>
</head>
<body>
<div class="auth-container">
    <h2>Register</h2>
    <form id="registerForm">
        <input type="text" id="fullName" placeholder="Full Name" required />
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <input type="tel" id="phone" placeholder="Phone Number" required />
        <select id="role" required>
            <option value="" disabled selected>Select role</option>
            <option value="DONOR">Donor</option>
            <option value="RECIPIENT">Recipient</option>
        </select>
        <div id="roleSpecificFields" style="display: none;">
            <div id="donorFields" style="display: none;">
                <select id="bloodType">
                    <option value="" disabled selected>Select Blood Type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
                <div>
                    <label for="lastDonationDate">Last Donation Date:</label>
                    <input type="date" id="lastDonationDate" />
                </div>
            </div>
        </div>
        <button type="submit">Register</button>
        <p>Already have an account? <a href="login.html">Login</a></p>

        <div id="message" style="margin-top:10px; font-weight:bold; display:none;"></div>
    </form>
</div>

<script>
    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', function() {
        if (AuthService.isAuthenticated()) {
            const userInfo = AuthService.getUserInfo();
            if (userInfo && userInfo.role) {
                AuthUtils.redirectToDashboard(userInfo.role);
            }
        }
        
        // Setup role-specific field visibility
        setupRoleSpecificFields();
    });

    function setupRoleSpecificFields() {
        const roleSelect = document.getElementById('role');
        const roleSpecificFields = document.getElementById('roleSpecificFields');
        const donorFields = document.getElementById('donorFields');

        roleSelect.addEventListener('change', function() {
            const selectedRole = this.value;
            
            if (selectedRole === 'DONOR') {
                roleSpecificFields.style.display = 'block';
                donorFields.style.display = 'block';
                document.getElementById('bloodType').required = true;
            } else {
                roleSpecificFields.style.display = 'none';
                donorFields.style.display = 'none';
                document.getElementById('bloodType').required = false;
            }
        });
    }

    // Handle registration form submission
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const phone = document.getElementById('phone').value.trim();
        const role = document.getElementById('role').value;
        const bloodType = document.getElementById('bloodType').value;
        const lastDonationDate = document.getElementById('lastDonationDate').value;

        // Clear previous messages
        AuthUtils.hideMessage('message');

        // Validate inputs
        if (!fullName || !email || !password || !phone || !role) {
            AuthUtils.showMessage('message', 'Please fill in all required fields', true);
            return;
        }

        if (!AuthUtils.validateEmail(email)) {
            AuthUtils.showMessage('message', 'Please enter a valid email address', true);
            return;
        }

        if (!AuthUtils.validatePassword(password)) {
            AuthUtils.showMessage('message', 'Password must be at least 8 characters long', true);
            return;
        }

        if (!AuthUtils.validatePhone(phone)) {
            AuthUtils.showMessage('message', 'Please enter a valid phone number', true);
            return;
        }

        if (role === 'DONOR' && !bloodType) {
            AuthUtils.showMessage('message', 'Please select a blood type for donor registration', true);
            return;
        }

        try {
            // Show loading state
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Registering...';
            submitButton.disabled = true;

            // Prepare registration data
            const registrationData = {
                fullName: fullName,
                email: email,
                password: password,
                phone: phone,
                role: role,
                bloodType: bloodType || null,
                lastDonationDate: lastDonationDate || null
            };

            // Attempt registration
            const response = await AuthService.register(registrationData);
            
            // Save token and user info
            AuthService.saveToken(response.token);
            AuthService.saveUserInfo({ email, role, fullName });

            // Show success message
            AuthUtils.showMessage('message', 'Registration successful! Redirecting...', false);

            // Redirect to appropriate dashboard
            setTimeout(() => {
                AuthUtils.redirectToDashboard(role);
            }, 1000);

        } catch (error) {
            console.error('Registration error:', error);
            AuthUtils.showMessage('message', error.message || 'Registration failed. Please try again.', true);
        } finally {
            // Reset button state
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    });
</script>
</body>
</html>