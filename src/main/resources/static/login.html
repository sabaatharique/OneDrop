<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | Login</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/auth.css" />
    <script src="assets/js/auth.js"></script>
</head>
<body>
<div class="auth-container">
    <h2>Login</h2>
    <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <select id="role" required>
            <option value="" disabled selected>Select role</option>
            <option value="DONOR">Donor</option>
            <option value="RECIPIENT">Recipient</option>
        </select>
        <button type="submit">Login</button>
        <p>Don't have an account? <a href="register.html">Register</a></p>
        <div id="message" style="margin-top:10px; font-weight:bold; display:none;"></div>
    </form>
</div>

<script>
    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', function() {
        if (AuthService.isAuthenticated()) {
            const userInfo = AuthService.getUserInfo();
            if (userInfo && userInfo.role) {
                AuthUtils.redirectToDashboard(userInfo.role);
            }
        }
    });

    // Handle login form submission
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        // Clear previous messages
        AuthUtils.hideMessage('message');

        // Validate inputs
        if (!email || !password || !role) {
            AuthUtils.showMessage('message', 'Please fill in all fields', true);
            return;
        }

        if (!AuthUtils.validateEmail(email)) {
            AuthUtils.showMessage('message', 'Please enter a valid email address', true);
            return;
        }

        if (!AuthUtils.validatePassword(password)) {
            AuthUtils.showMessage('message', 'Password must be at least 8 characters long', true);
            return;
        }

        try {
            // Show loading state
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Logging in...';
            submitButton.disabled = true;

            // Attempt login
            const response = await AuthService.login(email, password, role);
            
            // Save token and user info
            AuthService.saveToken(response.token);
            AuthService.saveUserInfo({ email, role });

            // Show success message
            AuthUtils.showMessage('message', 'Login successful! Redirecting...', false);

            // Redirect to appropriate dashboard
            setTimeout(() => {
                AuthUtils.redirectToDashboard(role);
            }, 1000);

        } catch (error) {
            console.error('Login error:', error);
            AuthUtils.showMessage('message', error.message || 'Login failed. Please try again.', true);
        } finally {
            // Reset button state
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    });
</script>
</body>
</html>