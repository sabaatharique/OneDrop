<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | Create Request</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="assets/js/api-config.js"></script>
    <script src="assets/js/auth.js"></script>
    <style>
        .form-container {
          max-width: 600px;
          margin: 30px auto;
          padding: 25px;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .form-container h2 {
          text-align: center;
          color: #c62828;
          margin-bottom: 20px;
        }

        .form-group {
          margin-bottom: 15px;
        }

        label {
          display: block;
          font-weight: bold;
          margin-bottom: 5px;
          color: #333;
        }

        input, select {
          width: 100%;
          padding: 10px;
          border-radius: 8px;
          border: 1px solid #ccc;
          font-size: 16px;
        }

        button {
          width: 100%;
          background-color: #c62828;
          color: white;
          padding: 12px;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 16px;
          transition: 0.2s;
        }

        button:hover {
          background-color: #a31515;
        }

        .message {
          margin-top: 15px;
          text-align: center;
          font-weight: bold;
          display: none;
        }

        .loading {
          opacity: 0.6;
          pointer-events: none;
        }

        .back-btn {
          display: inline-block;
          margin-top: 15px;
          text-decoration: none;
          color: #c62828;
          font-weight: bold;
        }

        #map {
          height: 300px;
          border-radius: 10px;
          margin-top: 10px;
        }

        .location-info {
          margin-top: 10px;
          padding: 10px;
          background: #f8f9fa;
          border-radius: 5px;
          font-size: 14px;
          color: #666;
        }

        .urgency-critical { color: #dc2626; font-weight: bold; }
        .urgency-high { color: #f59e0b; font-weight: bold; }
        .urgency-medium { color: #3b82f6; font-weight: bold; }
        .urgency-low { color: #16a34a; font-weight: bold; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="recipient_dash.html">Dashboard</a>
            <a href="create_request.html" class="active">Create Request</a>
            <a href="request_track.html">Request Update</a>
            <a href="request_hist.html">Request History</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1>Create Blood Request</h1>
            <a href="recipient_dash.html" class="back-btn">‚Üê Back to Dashboard</a>
        </header>

        <section class="form-container">
            <h2>Fill Out Request Form</h2>
            <form id="createRequestForm">
                <div class="form-group">
                    <label for="patientName">Patient Name</label>
                    <input type="text" id="patientName" name="patientName" placeholder="Enter patient's name" required>
                </div>

                <div class="form-group">
                    <label for="bloodGroup">Blood Group</label>
                    <select id="bloodGroup" name="bloodGroup" required>
                        <option value="" disabled selected>Select blood group</option>
                        <option>A+</option>
                        <option>A-</option>
                        <option>B+</option>
                        <option>B-</option>
                        <option>O+</option>
                        <option>O-</option>
                        <option>AB+</option>
                        <option>AB-</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" placeholder="Enter city" required>
                </div>

                <div class="form-group">
                    <label for="hospital">Hospital</label>
                    <input type="text" id="hospital" name="hospital" placeholder="Enter hospital name" required>
                </div>

                <!-- Map Integration -->
                <div class="form-group">
                    <label>Select Hospital Location</label>
                    <div id="map"></div>
                    <div id="locationInfo" class="location-info">
                        <strong>Selected Location:</strong> <span id="locationText">Click on the map or drag the marker to select hospital location</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="date">Required Date</label>
                    <input type="date" id="date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="urgency">Urgency Level</label>
                    <select id="urgency" name="urgency" required>
                        <option value="" disabled selected>Select urgency level</option>
                        <option value="LOW">Low - Can wait 1-2 weeks</option>
                        <option value="MEDIUM">Medium - Needed within 3-5 days</option>
                        <option value="HIGH">High - Needed within 24-48 hours</option>
                        <option value="CRITICAL">Critical - Emergency, needed immediately</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="contact">Contact Number</label>
                    <input type="text" id="contact" name="contact" placeholder="+8801XXXXXXXXX" required>
                </div>

                <!-- Hidden lat/lng fields -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">

                <button type="submit">Submit Request</button>
                <div class="message" id="responseMessage"></div>
            </form>
        </section>
    </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Check authentication and initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is authenticated and is a recipient
        if (!AuthService.isAuthenticated()) {
            window.location.href = 'login.html';
            return;
        }

        const userInfo = AuthService.getUserInfo();
        if (!userInfo || userInfo.role !== 'RECIPIENT') {
            alert('Only recipients can create blood requests.');
            window.location.href = 'login.html';
            return;
        }

        initializeMap();
        setupFormSubmission();
    });

    let map, marker;

    function initializeMap() {
        // Initialize Leaflet Map
        map = L.map('map').setView([23.8103, 90.4125], 12); // Default: Dhaka
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        marker = L.marker([23.8103, 90.4125], { draggable: true }).addTo(map);

        // Update lat/lng when marker moves
        marker.on('dragend', function (e) {
            const pos = e.target.getLatLng();
            updateLatLng(pos.lat, pos.lng);
        });

        // Click on map to move marker
        map.on('click', function (e) {
            marker.setLatLng(e.latlng);
            updateLatLng(e.latlng.lat, e.latlng.lng);
        });

        // Set default lat/lng
        updateLatLng(23.8103, 90.4125);
    }

    function updateLatLng(lat, lng) {
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        
        // Update location display
        updateLocationDisplay(lat, lng);
    }

    async function updateLocationDisplay(lat, lng) {
        try {
            // Use reverse geocoding to get address
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            
            const address = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById("locationText").textContent = address;
        } catch (error) {
            document.getElementById("locationText").textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
    }

    function setupFormSubmission() {
        document.getElementById("createRequestForm").addEventListener("submit", async function(e) {
            e.preventDefault();

            const userInfo = AuthService.getUserInfo();
            if (!userInfo) {
                alert('Session expired. Please login again.');
                window.location.href = 'login.html';
                return;
            }

            // Get form data
            const requestData = {
                patientName: document.getElementById("patientName").value.trim(),
                bloodGroup: document.getElementById("bloodGroup").value,
                city: document.getElementById("city").value.trim(),
                hospital: document.getElementById("hospital").value.trim(),
                requiredDate: document.getElementById("date").value,
                urgency: document.getElementById("urgency").value,
                contact: document.getElementById("contact").value.trim(),
                latitude: parseFloat(document.getElementById("latitude").value),
                longitude: parseFloat(document.getElementById("longitude").value)
            };

            // Validate form data
            if (!validateRequestData(requestData)) {
                return;
            }

            try {
                // Show loading state
                showLoading(true);
                hideMessage();

                // Submit request
                const response = await ApiService.post(API_CONFIG.endpoints.requests, requestData);
                
                // Show success message
                showMessage("Request submitted successfully!", false);
                
                // Reset form
                document.getElementById("createRequestForm").reset();
                updateLatLng(23.8103, 90.4125); // Reset map position

            } catch (error) {
                console.error('Error submitting request:', error);
                showMessage(error.message || "Failed to submit request. Please try again.", true);
            } finally {
                showLoading(false);
            }
        });
    }

    function validateRequestData(data) {
        if (!data.patientName) {
            showMessage("Please enter patient name", true);
            return false;
        }

        if (!data.bloodGroup) {
            showMessage("Please select blood group", true);
            return false;
        }

        if (!data.city) {
            showMessage("Please enter city", true);
            return false;
        }

        if (!data.hospital) {
            showMessage("Please enter hospital name", true);
            return false;
        }

        if (!data.requiredDate) {
            showMessage("Please select required date", true);
            return false;
        }

        if (!data.urgency) {
            showMessage("Please select urgency level", true);
            return false;
        }

        // Check if date is in the future
        const selectedDate = new Date(data.requiredDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            showMessage("Required date must be in the future", true);
            return false;
        }

        // Validate urgency vs date
        const daysUntilRequired = Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24));
        
        if (data.urgency === 'CRITICAL' && daysUntilRequired > 1) {
            showMessage("Critical requests should be needed within 24 hours", true);
            return false;
        } else if (data.urgency === 'HIGH' && daysUntilRequired > 3) {
            showMessage("High urgency requests should be needed within 3 days", true);
            return false;
        } else if (data.urgency === 'MEDIUM' && daysUntilRequired > 7) {
            showMessage("Medium urgency requests should be needed within a week", true);
            return false;
        }

        if (!data.contact) {
            showMessage("Please enter contact number", true);
            return false;
        }

        if (!data.latitude || !data.longitude) {
            showMessage("Please select hospital location on the map", true);
            return false;
        }

        return true;
    }

    function showMessage(message, isError = false) {
        const messageElement = document.getElementById("responseMessage");
        messageElement.textContent = message;
        messageElement.style.color = isError ? 'red' : 'green';
        messageElement.style.display = 'block';
    }

    function hideMessage() {
        const messageElement = document.getElementById("responseMessage");
        messageElement.style.display = 'none';
    }

    function showLoading(show) {
        const form = document.getElementById("createRequestForm");
        const submitButton = form.querySelector('button[type="submit"]');
        
        if (show) {
            form.classList.add('loading');
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;
        } else {
            form.classList.remove('loading');
            submitButton.textContent = 'Submit Request';
            submitButton.disabled = false;
        }
    }
</script>
</body>
</html>
