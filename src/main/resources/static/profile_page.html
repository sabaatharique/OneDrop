<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | User Profile</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <style>
        .profile-card {
          background: #fff;
          padding: 25px;
          border-radius: 10px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
          margin-bottom: 20px;
        }
        .profile-card h2 {
          margin-bottom: 20px;
          color: #dc2626;
        }
        .profile-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
        }
        .profile-info div {
          background: #f3f4f6;
          padding: 15px;
          border-radius: 6px;
        }
        .profile-info div h3 {
          margin-bottom: 8px;
          color: #dc2626;
        }
        .profile-info div p {
          margin: 0;
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav id="sidebar-links"></nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1>User Profile</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <section class="tables">
            <div class="profile-card">
                <h2>My Information</h2>
                <div class="profile-info">
                    <div>
                        <h3>Name</h3>
                        <p id="name">Loading...</p>
                    </div>
                    <div>
                        <h3>Blood Group</h3>
                        <p id="bloodType">Loading...</p>
                    </div>
                    <div>
                        <h3>Last Donated</h3>
                        <p id="lastDonation">Loading...</p>
                    </div>
                    <div>
                        <h3>Last Received Request</h3>
                        <p id="lastRequest">Loading...</p>
                    </div>
                    <div>
                        <h3>Total Donations</h3>
                        <p id="totalDonations">Loading...</p>
                    </div>
                    <div>
                        <h3>Total Received</h3>
                        <p id="totalReceived">Loading...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const role = localStorage.getItem("userRole");
    const sidebar = document.getElementById("sidebar-links");

    if (role === "DONOR") {
      sidebar.innerHTML = `
        <a href="profile_page.html" class="active">Dashboard</a>
        <a href="request_page.html">Find Requests</a>
        <a href="track_donations.html">Track Donations</a>
        <a href="donation_calendar.html">Donation Calendar</a>
      `;
    } else if (role === "RECIPIENT") {
      sidebar.innerHTML = `
        <a href="profile_page.html" class="active">Dashboard</a>
        <a href="donors.html">Donors</a>
        <a href="recipients.html">Recipients</a>
        <a href="requests.html">Requests</a>
      `;
    }

    async function loadProfile() {
      try {
        const token = localStorage.getItem("jwtToken");
        const donorId = localStorage.getItem("donorId");
        const recipientId = localStorage.getItem("recipientId");

        if (role === "DONOR" && donorId) {
          const res = await axios.get(`/donors/${donorId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const donor = res.data;
          document.getElementById("name").textContent = donor.user?.fullName || "N/A";
          document.getElementById("bloodType").textContent = donor.bloodType || "N/A";
          document.getElementById("lastDonation").textContent = donor.lastDonationDate || "N/A";
          document.getElementById("lastRequest").textContent = donor.lastRequestDate || "N/A";
          document.getElementById("totalDonations").textContent = donor.totalDonations || "0";
          document.getElementById("totalReceived").textContent = donor.totalReceived || "0";
        }

        if (role === "RECIPIENT" && recipientId) {
          const res = await axios.get(`/recipients/${recipientId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const recipient = res.data;
          document.getElementById("name").textContent = recipient.user?.fullName || "N/A";
          document.getElementById("bloodType").textContent = recipient.bloodType || "N/A";
          document.getElementById("lastDonation").textContent = recipient.lastDonationDate || "N/A";
          document.getElementById("lastRequest").textContent = recipient.lastRequestDate || "N/A";
          document.getElementById("totalDonations").textContent = recipient.totalDonations || "0";
          document.getElementById("totalReceived").textContent = recipient.totalReceived || "0";
        }
      } catch (err) {
        console.error("Could not load profile:", err);
        document.getElementById("name").textContent = "Error loading profile";
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    loadProfile();
</script>
</body>
</html>
