<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | Recipient Dashboard</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />
    <script src="assets/js/api-config.js"></script>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="recipient_dash.html" class="active">Dashboard</a>
            <a href="requests.html">Create Request</a>
            <a href="request_track.html">Request Update</a>
            <a href="request_hist.html">Request History</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar">
            <h1>Recipient Dashboard</h1>
            <button class="logout-btn">Logout</button>
        </header>

        <!-- Stats cards relevant for recipients -->
        <section class="stats">
            <div class="card">Your Requests <span id="total-requests">-</span></div>
            <div class="card">Completed Requests <span id="completed-requests">-</span></div>
            <div class="card">Matched Donors <span id="matched-donors">-</span></div>
        </section>

        <!-- Tables -->
        <section class="tables">
            <div class="table-container">
                <h2>Latest Requests</h2>
                <table>
                    <thead>
                    <tr>
                        <th>Request Date</th>
                        <th>Blood Type</th>
                        <th>Status</th>
                        <th>Hospital</th>
                    </tr>
                    </thead>
                    <tbody id="recipient-requests-body">
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<script>
    const recipientId = 1; // TODO: Replace with logged-in recipient ID

    // Load recipient dashboard data when page loads
    document.addEventListener('DOMContentLoaded', async function() {
        await loadRecipientDashboard();
    });

    async function loadRecipientDashboard() {
        try {
            await loadRecipientStats();
            await loadRecipientRequests();
        } catch (error) {
            console.error('Error loading recipient dashboard:', error);
        }
    }

    async function loadRecipientStats() {
        try {
            // Get all requests for this recipient
            const requests = await ApiService.get(`${API_CONFIG.endpoints.requests}/recipient/${recipientId}`);
            
            const totalRequests = requests.length;
            const completedRequests = requests.filter(req => req.status === 'COMPLETED').length;
            const matchedRequests = requests.filter(req => req.status === 'MATCHED' || req.status === 'APPROVED').length;

            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('completed-requests').textContent = completedRequests;
            document.getElementById('matched-donors').textContent = matchedRequests;
        } catch (error) {
            console.error('Error loading recipient stats:', error);
            document.getElementById('total-requests').textContent = '0';
            document.getElementById('completed-requests').textContent = '0';
            document.getElementById('matched-donors').textContent = '0';
        }
    }

    async function loadRecipientRequests() {
        const tbody = document.getElementById('recipient-requests-body');
        Utils.showLoading(tbody);

        try {
            const requests = await ApiService.get(`${API_CONFIG.endpoints.requests}/recipient/${recipientId}`);
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px;">No requests found</td></tr>';
                return;
            }

            // Show only the latest 5 requests
            const latestRequests = requests.slice(0, 5);
            
            tbody.innerHTML = latestRequests.map(request => `
                <tr>
                    <td>${Utils.formatDate(request.requiredDate)}</td>
                    <td>${request.bloodGroup || '-'}</td>
                    <td>${Utils.formatStatus(request.status)}</td>
                    <td>${request.hospital || '-'}</td>
                </tr>
            `).join('');
        } catch (error) {
            Utils.showError(tbody, 'Failed to load requests');
        }
    }
</script>
</body>
</html>
