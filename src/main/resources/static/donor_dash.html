<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrop | Donor Dashboard</title>
    <script src="assets/js/api-config.js"></script>
    <style>
        /* Reset and base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f9fafb; color: #222; }
        a { text-decoration: none; color: inherit; }

        /* Dashboard Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar {
          width: 230px;
          background: #dc2626;
          color: white;
          padding: 20px;
          display: flex;
          flex-direction: column;
        }
        .sidebar h2 { margin-bottom: 20px; }
        .sidebar nav a {
          color: white;
          padding: 10px 0;
          display: block;
          border-radius: 6px;
        }
        .sidebar nav a.active, .sidebar nav a:hover { background: rgba(255,255,255,0.2); }
        .main-content { flex: 1; padding: 20px; }
        .topbar { display: flex; justify-content: space-between; align-items-center; margin-bottom: 20px; }

        /* Stats Section */
        .stats {
          display: flex;
          flex-direction: column;
          gap: 15px;
          margin-bottom: 30px;
          max-width: 350px;
        }
        .card {
          background: #fff;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          font-weight: bold;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
          font-size: 1.2rem;
        }
        .card span {
          font-size: 2rem;
          color: #dc2626;
          margin-top: 10px;
        }

        /* Past Donations Section */
        #past-donations-section {
          display: none;
          margin-top: 15px;
          background: #fff;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #past-donations-list {
          list-style: none;
          padding: 0;
        }
        #past-donations-list li {
          margin-bottom: 8px;
          font-size: 0.95rem;
          color: #333;
        }

        /* Requests Section */
        .appointments {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          margin-bottom: 30px;
        }
        .appointment-card {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          display: flex;
          flex-direction: column;
          gap: 10px;
          position: relative;
        }
        .appointment-card h3 { color: #dc2626; font-size: 1.2rem; }
        .appointment-card p { font-size: 0.95rem; color: #333; }
        .btn {
          background: #dc2626;
          color: white;
          padding: 10px 14px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          margin-top: 10px;
          transition: background 0.3s;
        }
        .btn:hover { background: #b91c1c; }

        /* Upcoming Appointment Card */
        #upcoming-appointment {
          background: #fff;
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          margin-top: 20px;
        }
        #upcoming-appointment h3 {
          color: #dc2626;
          margin-bottom: 10px;
        }
        #upcoming-appointment p {
          font-size: 1rem;
          margin-bottom: 6px;
        }
        #cancel-btn {
          margin-top: 12px;
          background: #555;
        }
        #cancel-btn:hover { background: #333; }

        /* Hide element */
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="donor_dash.html" class="active">Dashboard</a>
            <a href="request_page.html">Find requests</a>
            <a href="track_donations.html">Track Donations</a>
            <a href="donation_calendar.html">Donation Calendar</a>
            <a href="matches.html">Matches</a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="topbar">
            <h1>Donor Dashboard</h1>
            <a href="profile_page.html" style="font-weight: bold; color: #000000; text-decoration: none;">Profile</a>
        </header>

        <!-- Stats cards -->
        <section class="stats">
            <div class="card">
                Your Donations
                <span id="total-donations">0</span>
                <button id="show-past-btn" class="btn" style="margin-top: 12px;">View Past Donations</button>
                <section id="past-donations-section">
                    <h4 style="color:#dc2626; margin-bottom:10px;">Past Donations</h4>
                    <ul id="past-donations-list"></ul>
                </section>
            </div>

            <div class="card">
                Upcoming Donations
                <span id="upcoming-count">0</span>
            </div>
        </section>

        <!-- Upcoming Appointment Section -->
        <section id="upcoming-appointment" class="hidden">
            <h3>Your Upcoming Appointment</h3>
            <p><strong>Hospital:</strong> <span id="hospital"></span></p>
            <p><strong>Date:</strong> <span id="date"></span></p>
            <p><strong>Status:</strong> <span id="status"></span></p>
            <p><strong>Recipient:</strong> <span id="recipient-name"></span></p>
            <p><strong>Blood Type:</strong> <span id="recipient-blood"></span></p>
            <p><strong>Location:</strong> <span id="recipient-location"></span></p>
            <button id="cancel-btn" class="btn">Cancel Appointment</button>
        </section>

        <!-- All Available Requests -->
        <h2 style="margin-bottom: 15px;">Available Requests</h2>
        <section id="request-list" class="appointments"></section>
    </main>
</div>

<script>
    const donorId = 1; // TODO: Replace with logged-in donor ID

    const requestList = document.getElementById("request-list");
    const upcomingAppointment = document.getElementById("upcoming-appointment");
    const hospitalEl = document.getElementById("hospital");
    const dateEl = document.getElementById("date");
    const statusEl = document.getElementById("status");
    const recipientNameEl = document.getElementById("recipient-name");
    const recipientBloodEl = document.getElementById("recipient-blood");
    const recipientLocationEl = document.getElementById("recipient-location");
    const cancelBtn = document.getElementById("cancel-btn");

    const pastBtn = document.getElementById("show-past-btn");
    const pastSection = document.getElementById("past-donations-section");
    const pastList = document.getElementById("past-donations-list");

    // Fetch donor's appointment
    async function fetchAppointment() {
      try {
        const res = await fetch(`${API_CONFIG.baseUrl}/api/requests/donor/${donorId}/upcoming`);
        if (res.status === 204 || res.status === 404) {
          // No active appointment
          upcomingAppointment.classList.add("hidden");
          fetchRequests();
        } else {
          const data = await res.json();
          showAppointment(data);
        }
      } catch (error) {
        console.error('Error fetching appointment:', error);
        upcomingAppointment.classList.add("hidden");
        fetchRequests();
      }
    }

    // Show upcoming appointment
    function showAppointment(data) {
      upcomingAppointment.classList.remove("hidden");
      hospitalEl.textContent = data.hospital || 'Unknown';
      dateEl.textContent = Utils.formatDate(data.requiredDate);
      statusEl.textContent = Utils.formatStatus(data.status);
      recipientNameEl.textContent = data.patientName || 'Unknown';
      recipientBloodEl.textContent = data.bloodGroup || '-';
      recipientLocationEl.textContent = data.city || '-';
      requestList.innerHTML = ""; // Hide other requests
    }

    // Fetch all available requests
    async function fetchRequests() {
      try {
        const data = await ApiService.get(`${API_CONFIG.endpoints.requests}/pending`);
        renderRequests(data);
      } catch (error) {
        console.error('Error fetching requests:', error);
        requestList.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Failed to load requests</div>';
      }
    }

    // Render request cards
    function renderRequests(requests) {
      requestList.innerHTML = "";
      if (requests.length === 0) {
        requestList.innerHTML = '<div style="text-align:center; padding:20px;">No available requests</div>';
        return;
      }
      
      requests.forEach(req => {
        const card = document.createElement("div");
        card.classList.add("appointment-card");
        card.innerHTML = `
          <h3>${req.hospital || 'Unknown Hospital'}</h3>
          <p><strong>Patient:</strong> ${req.patientName || 'Unknown'}</p>
          <p><strong>Blood Type:</strong> ${req.bloodGroup || '-'}</p>
          <p><strong>Location:</strong> ${req.city || '-'}</p>
          <p><strong>Date:</strong> ${Utils.formatDate(req.requiredDate)}</p>
          <button class="btn" onclick="bookAppointment(${req.id})">Confirm Appointment</button>
        `;
        requestList.appendChild(card);
      });
    }

    // Book an appointment
    async function bookAppointment(requestId) {
      try {
        const res = await fetch(`${API_CONFIG.baseUrl}/api/requests/${requestId}/accept?donorID=${donorId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" }
        });

        if (res.ok) {
          alert("Appointment booked successfully!");
          fetchAppointment();
        } else {
          const error = await res.text();
          alert(error);
        }
      } catch (error) {
        console.error('Error booking appointment:', error);
        alert('Failed to book appointment. Please try again.');
      }
    }

    // Cancel appointment
    cancelBtn.addEventListener("click", async () => {
      try {
        // First get the current request ID, then cancel it
        const res = await fetch(`${API_CONFIG.baseUrl}/api/requests/donor/${donorId}/upcoming`);
        if (res.ok) {
          const request = await res.json();
          const cancelRes = await fetch(`${API_CONFIG.baseUrl}/api/requests/${request.id}/cancel`, { 
            method: "PUT" 
          });
          if (cancelRes.ok) {
            alert("Appointment cancelled!");
            fetchAppointment();
          } else {
            alert("Failed to cancel appointment");
          }
        }
      } catch (error) {
        console.error('Error cancelling appointment:', error);
        alert('Failed to cancel appointment. Please try again.');
      }
    });

    // Toggle past donations
    pastBtn.addEventListener("click", async () => {
      if (pastSection.style.display === "none" || pastSection.style.display === "") {
        try {
          const data = await ApiService.get(`${API_CONFIG.endpoints.requests}/donor/${donorId}/history`);
          pastList.innerHTML = data.length > 0
            ? data.map(d => `<li>${Utils.formatDate(d.requiredDate)} — ${d.hospital || 'Unknown'} — ${d.bloodGroup || '-'}</li>`).join("")
            : "<li>No past donations found</li>";
          pastSection.style.display = "block";
          pastBtn.textContent = "Hide Past Donations";
        } catch (error) {
          console.error('Error fetching past donations:', error);
          pastList.innerHTML = "<li>Failed to load past donations</li>";
          pastSection.style.display = "block";
          pastBtn.textContent = "Hide Past Donations";
        }
      } else {
        pastSection.style.display = "none";
        pastBtn.textContent = "View Past Donations";
      }
    });

    // Load initial data
    fetchAppointment();
</script>
</body>
</html>