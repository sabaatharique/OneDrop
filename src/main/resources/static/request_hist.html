<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneDrop | Request History</title>
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="stylesheet" href="assets/css/dashboard.css" />

    <script src="assets/js/auth.js"></script>
    <style>
        .table-container {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #dc2626;
            color: white;
        }
        tr:hover { background: #f1f1f1; }
        .empty-message {
            text-align: center;
            padding: 20px;
            color: #555;
        }
        .hidden { display: none; }
        .status-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: default;
            color: white;
            font-weight: bold;
        }
        .back-btn {
            display: inline-block;
            margin-top: 15px;
            text-decoration: none;
            color: #c62828;
            font-weight: bold;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            width : auto;
        }
        .back-btn:hover {
            background: #b91c1c;
        }
        .status-pending { background: #f59e0b; }
        .status-approved { background: #16a34a; }
        .status-rejected { background: #dc2626; }
        .status-completed { background: #16a34a; }
        .status-cancelled { background: #dc2626; }
        .status-matched { background: #3b82f6; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>OneDrop</h2>
        <nav>
            <a href="profile_page.html">Dashboard</a>
            <a href="requests.html">Create Request</a>
            <a href="request_hist.html" class="active">Request History</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="topbar" style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Request History</h1>
            <button class="back-btn" onclick="location.href='index.html'">Back to Home</button>
        </header>

        <div class="table-container">
            <h2>Your Past Requests</h2>
            <table id="historyTable">
                <thead>
                <tr>
                    <th>Request Date</th>
                    <th>Blood Type</th>
                    <th>Status</th>
                    <th>Address</th>
                    <th>Donor Contact</th>
                </tr>
                </thead>
                <tbody id="historyBody">
                <!-- Data will populate here -->
                </tbody>
            </table>
            <div id="emptyMessage" class="empty-message hidden">No past requests found.</div>
        </div>
    </main>
</div>

<script>
    const Utils = {
        formatDate: function(dateString) {
            if (!dateString) return '-';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        },
        formatStatus: function(status) {
            if (!status) return '-';
            return status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();
        }
    };

    function getStatusClass(status) {
        if (!status) return '';
        switch(status.toUpperCase()) {
            case 'PENDING': return 'status-pending';
            case 'MATCHED': return 'status-matched';
            case 'FULFILLED': return 'status-completed';
            case 'CANCELLED': return 'status-cancelled';
            case 'EXPIRED': return 'status-rejected';
            default: return '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('jwtToken');
        const userRole = localStorage.getItem('userRole');
        const activeProfile = localStorage.getItem('activeProfile');

        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        let userIdToFetch;
        let userTypeToFetch;

        if (userRole === 'BOTH') {
            if (activeProfile === 'RECIPIENT') {
                userIdToFetch = localStorage.getItem('recipientId');
                userTypeToFetch = 'recipient';
            } else {
                userIdToFetch = localStorage.getItem('donorId');
                userTypeToFetch = 'donor';
                localStorage.setItem('activeProfile', 'DONOR');
            }
        } else if (userRole === 'RECIPIENT') {
            userIdToFetch = localStorage.getItem('recipientId');
            userTypeToFetch = 'recipient';
        } else if (userRole === 'DONOR') {
            userIdToFetch = localStorage.getItem('donorId');
            userTypeToFetch = 'donor';
        } else {
            alert('Unauthorized access.');
            window.location.href = 'login.html';
            return;
        }

        if (!userIdToFetch) {
            alert('User ID not found for the selected profile.');
            window.location.href = 'login.html';
            return;
        }

        fetchRequestHistory(userTypeToFetch, userIdToFetch, token);
    });

    async function fetchRequestHistory(userType, userId, token) {
        try {
            historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>';
            emptyMessage.classList.add("hidden");

            let url;
            if (userType === 'recipient') {
                url = `http://localhost:8000/api/requests/recipient/${userId}`;
            } else if (userType === 'donor') {
                url = `http://localhost:8000/api/requests/donor/${userId}/history`;
            } else {
                throw new Error('Invalid user type');
            }

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error("Failed to fetch");

            const requests = await response.json();

            if (requests.length === 0) {
                historyBody.innerHTML = '';
                emptyMessage.textContent = "No request history found.";
                emptyMessage.classList.remove("hidden");
                return;
            }

            historyBody.innerHTML = '';
            requests.forEach(req => {
                const tr = document.createElement("tr");

                // Donor contact as plain black text
                const donorContact = req.donorPhone && req.donorPhone !== '-'
                    ? req.donorPhone
                    : '-';

                tr.innerHTML = `
                    <td>${Utils.formatDate(req.createdAt)}</td>
                    <td>${req.bloodType || '-'}</td>
                    <td><span class="status-btn ${getStatusClass(req.status)}">${Utils.formatStatus(req.status)}</span></td>
                    <td>${req.location?.address || '-'}</td>
                    <td>${donorContact}</td>
                `;
                historyBody.appendChild(tr);
            });
        } catch (err) {
            console.error("Error:", err);
            historyBody.innerHTML = '';
            emptyMessage.textContent = "Failed to fetch request history. Please try again.";
            emptyMessage.classList.remove("hidden");
        }
    }
</script>
</body>
</html>
